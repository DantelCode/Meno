<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>
    <%= title %>
  </title>
  <link rel="stylesheet" href="styles/layout.css">
</head>

<body>
  <header role="banner" aria-label="Main header">
    <div class="brand">
      <div class="logo">M</div>
      <div class="name">Meno</div>
    </div>

    <nav class="nav" role="navigation" aria-label="Primary navigation">
      <a href="dashboard" class="nav-btn" data-target="dashboard" aria-current="page" title="Dashboard">
        <svg width="20" height="20" viewBox="0 0 24 24" class="icon" role="img" aria-label="Dashboard">
          <title>Dashboard</title>
          <rect x="3" y="3" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.25" fill="none" />
          <rect x="13" y="3" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.25" fill="none" />
          <rect x="3" y="13" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.25" fill="none" />
          <rect x="13" y="13" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.25" fill="none" />
        </svg>
        <span>Dashboard</span>
      </a>

      <a href="events" class="nav-btn" data-target="events" title="Events">
        <svg width="20" height="20" viewBox="0 0 24 24" class="icon" role="img" aria-label="Events">
          <title>Events</title>
          <rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.2" fill="none" />
          <path d="M16 3v4M8 3v4" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" />
          <path d="M3 11h18" stroke="currentColor" stroke-width="1" stroke-linecap="round" />
        </svg>
        <span>Events</span>
      </a>

      <a href="meals" class="nav-btn" data-target="meals" title="Meals">
        <svg width="20" height="20" viewBox="0 0 24 24" class="icon" role="img" aria-label="Meals">
          <title>Meals</title>
          <path d="M7 2v8" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" />
          <path d="M11 2v8" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" />
          <path d="M3 16a9 9 0 0018 0" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" fill="none" />
        </svg>
        <span>Meals</span>
      </a>

      <a href="shopping" class="nav-btn" data-target="shopping" title="Shopping">
        <svg width="20" height="20" viewBox="0 0 24 24" class="icon" role="img" aria-label="Shopping">
          <title>Shopping</title>
          <path d="M3 3h2l1 5h12l1.5 6H7" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round" fill="none" />
          <circle cx="10" cy="19" r="1" fill="currentColor" />
          <circle cx="17" cy="19" r="1" fill="currentColor" />
        </svg>
        <span>Shopping</span>
      </a>

      <a href="support" class="nav-btn" data-target="support" title="Support">
        <svg xmlns="http://www.w3.org/2000/svg" id="hand-star" viewBox="0 0 1000 1000" class="icon" role="img" aria-label="Support" fill="var(--text-primary)">
          <path d="m766.44 536.51-136.65 71.8c-8.61 4.52-17.5 8.48-26.6 11.86 1.99-6.89 3.06-14.16 3.06-21.67 0-43.07-35.04-78.11-78.1-78.11h-125.52c-35.37 0-69.63 7.42-101.83 22.03l-158.79 72.06c-7.52 3.42-12.36 10.92-12.36 19.18v180.51c0 11.63 9.43 21.06 21.06 21.06h331.05c48.61 0 96.09-13.63 137.3-39.43l217.97-136.43c16.46-10.3 27.73-26.43 31.75-45.43 4.02-19 .24-38.31-10.64-54.4-20.26-29.96-59.69-39.85-91.7-23.04ZM827.57 605.24c-1.63 7.71-6.21 14.25-12.89 18.44l-217.97 136.43c-34.5 21.59-74.25 33.01-114.95 33.01H171.78v-145.87l146.43-66.46c26.7-12.12 55.1-18.27 84.42-18.27h125.52c19.84 0 35.98 16.15 35.98 35.99s-14.56 34.35-33.02 35.86c-2.46.08-4.91.12-7.37.12h-119.84c-11.63 0-21.06 9.43-21.06 21.06s9.43 21.06 21.06 21.06h124.25c1.77 0 3.53-.06 5.27-.17 40.33-1.47 80.23-12.05 115.97-30.83l136.65-71.8c13-6.82 29-2.8 37.22 9.35 4.42 6.53 5.95 14.37 4.32 22.08ZM784.51 277.87c-2.5-7.7-9.19-13.28-17.21-14.36l-83.11-11.25-36.38-75.57c-3.51-7.29-10.89-11.92-18.98-11.92s-15.47 4.63-18.98 11.92l-36.38 75.57-83.12 11.25c-8.02 1.09-14.71 6.66-17.21 14.37-2.5 7.69-.37 16.14 5.48 21.73l60.63 57.95-14.99 82.52c-1.45 7.96 1.8 16.04 8.34 20.81 3.67 2.66 8.02 4.02 12.38 4.02 3.42 0 6.85-.83 9.98-2.52l73.85-39.75 73.85 39.75c7.12 3.85 15.82 3.26 22.37-1.5 6.55-4.76 9.79-12.85 8.34-20.81l-14.98-82.52 60.63-57.95c5.85-5.59 7.98-14.04 5.48-21.74ZM681.09 334.94c-5.12 4.89-7.44 12.02-6.17 18.98l9.19 50.63-45.31-24.38c-3.12-1.68-6.55-2.52-9.98-2.52s-6.87.84-9.98 2.52l-45.31 24.38 9.2-50.63c1.26-6.96-1.05-14.1-6.17-18.98l-37.2-35.56 50.99-6.9c7.02-.95 13.08-5.36 16.15-11.74l22.32-46.37 22.32 46.37c3.07 6.38 9.14 10.79 16.15 11.74l50.99 6.9-37.2 35.56Z"></path>
        </svg>
        <span>Support</span>
      </a>
    </nav>

    <div class="controls" role="group" aria-label="Controls">
      <div class="search-input" id="searchWrap">
        <button class="control-btn" id="searchToggle" title="Search" aria-expanded="false" aria-controls="searchInput">
          <svg width="18" height="18" viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16a6.471 6.471 0 004.23-1.57l.27.28v.79L20 20.49 21.49 19 15.5 14z" fill="none" />
          </svg>
        </button>
        <input id="searchInput" type="search" placeholder="Search..." aria-label="Search" />
      </div>

      <button id="theme" class="nav-btn" title="Theme" aria-pressed="false" aria-label="Toggle theme">
        <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24">
          <path fill="currentColor" d="M12 3a9 9 0 100 18 9 9 0 000-18z" />
        </svg>
      </button>

      <button class="nav-btn sidebar" onclick="openSidebar()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="icon">
          <path d="M7 11h10v6H7zM5 3h2v2H5zM17 3h2v2h-2zM3 7h18v2H3z" fill="currentColor" />
        </svg>
      </button>
    </div>
  </header>

  <main>
    <div id="toastContainer"></div>
    <%- body %>
  </main>


  <script>
    const root = document.documentElement;
    const THEME_KEY = 'meno_theme';
    const themeBtn = document.getElementById('theme');
    const themeIcon = document.getElementById('themeIcon');

    function applyTheme(mode) {
      if (mode === 'dark') {
        root.setAttribute('data-theme', 'dark');
        themeBtn.setAttribute('aria-pressed', 'true');
        // moon icon
        themeIcon.innerHTML = '<path fill=\"currentColor\" d=\"M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z\"/>';
      } else {
        root.setAttribute('data-theme', 'light');
        themeBtn.setAttribute('aria-pressed', 'false');
        // sun icon
        themeIcon.innerHTML = '<circle cx=\"15\" cy=\"15\" r=\"6\" fill=\"#464646\"></circle><path fill=\"#464646\" d=\"M15 6a1 1 0 0 1-1-1V3a1 1 0 0 1 2 0v2a1 1 0 0 1-1 1zm0 22a1 1 0 0 1-1-1v-2a1 1 0 0 1 2 0v2a1 1 0 0 1-1 1zM5 16H3a1 1 0 0 1 0-2h2a1 1 0 0 1 0 2zm22 0h-2a1 1 0 0 1 0-2h2a1 1 0 0 1 0 2zM6.51 24.49a1 1 0 0 1-.7-.3 1 1 0 0 1 0-1.41l1.41-1.42a1 1 0 0 1 1.42 1.42l-1.42 1.41a1 1 0 0 1-.71.3zM22.07 8.93a1 1 0 0 1-.71-.29 1 1 0 0 1 0-1.42l1.42-1.41a1 1 0 0 1 1.41 1.41l-1.41 1.42a1 1 0 0 1-.71.29zm1.42 15.56a1 1 0 0 1-.71-.3l-1.42-1.41a1 1 0 0 1 1.42-1.42l1.41 1.42a1 1 0 0 1 0 1.41 1 1 0 0 1-.7.3zM7.93 8.93a1 1 0 0 1-.71-.29L5.81 7.22a1 1 0 0 1 1.41-1.41l1.42 1.41a1 1 0 0 1 0 1.42 1 1 0 0 1-.71.29z\"></path>';
      }
      localStorage.setItem(THEME_KEY, mode);
    }

    // initialize from storage or system
    (function() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved) applyTheme(saved);
      else applyTheme(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    })();

    themeBtn.addEventListener('click', () => {
      const curr = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      applyTheme(curr === 'dark' ? 'light' : 'dark');
    });

    /* -------------------------
       Nav buttons -> scroll + active
       ------------------------- */
    const navBtns = Array.from(document.querySelectorAll('nav.nav .nav-btn[data-target]'));
    const sections = navBtns.map(b => document.getElementById(b.dataset.target));
    navBtns.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = btn.dataset.target;
        const el = document.getElementById(id);
        if (!el) return;

        // visually update
        navBtns.forEach(n => n.classList.remove('active'));
        btn.classList.add('active');

        await fetch(`/${btn.getAttribute('data-target')}`);

        navBtns.forEach(b => b.removeAttribute('aria-current'));
        btn.setAttribute('aria-current', 'page');
      });
    });


    /* -------------------------
       Search open/close
       ------------------------- */
    const searchWrap = document.getElementById('searchWrap');
    const searchToggle = document.getElementById('searchToggle');
    const searchInput = document.getElementById('searchInput');
    searchToggle.addEventListener('click', () => {
      const open = searchWrap.classList.toggle('open');
      searchToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      if (open) setTimeout(() => searchInput.focus(), 120);
    });
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchWrap.classList.remove('open');
        searchToggle.setAttribute('aria-expanded', 'false');
        searchToggle.focus();
      }
    });

    /* -------------------------
       small accessibility + keyboard
       ------------------------- */
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd+K to open search
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        if (!searchWrap.classList.contains('open')) {
          searchWrap.classList.add('open');
          setTimeout(() => searchInput.focus(), 120);
        } else searchInput.focus();
      }
    });

    /* Ensure nav labels reveal for currently active item on pageload */
    window.addEventListener('load', () => {
      const active = document.querySelector('nav.nav .nav-btn.active');
      if (active) active.classList.add('active');
    });

    /* ======================
 NAVBAR: set active based on path (non-destructive)
====================== */
    function setActiveNav() {
      try {
        const navBtns = Array.from(document.querySelectorAll('nav.nav .nav-btn[data-target]'));
        const path = window.location.pathname.replace(/^\//, '') || 'dashboard';
        navBtns.forEach(btn => {
          const isActive = btn.getAttribute('data-target') === path;
          btn.classList.toggle('active', isActive);
          if (isActive) btn.setAttribute('aria-current', 'page');
          else btn.removeAttribute('aria-current');
        });

        // Hide search on dashboard and support pages
        const searchWrap = document.getElementById('searchWrap');
        if (searchWrap) {
          const hideSearchOn = ['dashboard', 'support'];
          if (hideSearchOn.includes(path)) {
            searchWrap.style.display = 'none';
          } else {
            searchWrap.style.display = '';
          }
        }
      } catch (e) {
        // fail silently to avoid breaking page
        console.warn('setActiveNav failed', e);
      }
    }

    /* ======================
SIDEBAR: mobile menu toggle
====================== */
    function openSidebar() {
      try {
        const nav = document.querySelector('nav.nav');
        if (nav) {
          nav.classList.toggle('mobile-open');
        }
      } catch (e) {
        console.warn('openSidebar failed', e);
      }
    }
  </script>

  <!-- EmailJS SDK for sending feedback emails -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/index.min.js"></script>
</body>

</html>